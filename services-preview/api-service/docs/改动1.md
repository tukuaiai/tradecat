# 代码变更说明 - API Service 创建与 CoinGlass V4 规范对齐

> 变更日期: 2026-01-16
> Git 提交: e591f3df, bdc8c88c, d4d6d1fd

---

## 1. 任务概述

- **任务/问题**：创建对外数据消费 API 服务，对齐 CoinGlass API V4 规范；修复 telegram-service psutil 依赖缺失
- **目标**：
  1. 在 `services-preview/` 下创建符合项目标准的 api-service
  2. 实现 CoinGlass V4 风格的 API 规范（响应格式、端点命名、参数设计）
  3. 修复 telegram-service `No module named 'psutil'` 错误
- **影响范围**：
  - 新增：`services-preview/api-service/` 完整服务
  - 修改：`services/telegram-service/requirements.txt`
  - 数据源：TimescaleDB (端口 5433)、SQLite (market_data.db、cooldown.db)

---

## 2. 改动清单与位置（Where）

### 改动点 #1
- **文件**：`services/telegram-service/requirements.txt`
- **位置**：文件末尾
- **变更类型**：修改
- **变更摘要**：添加 `psutil>=5.9.0` 依赖

### 改动点 #2
- **文件**：`services-preview/api-service/src/utils/__init__.py`
- **位置**：新文件
- **变更类型**：新增
- **变更摘要**：工具模块初始化，导出 ErrorCode、api_response、error_response

### 改动点 #3
- **文件**：`services-preview/api-service/src/utils/errors.py`
- **位置**：`ErrorCode` 枚举类、`api_response()` 函数、`error_response()` 函数
- **变更类型**：新增
- **变更摘要**：统一响应格式和错误码定义（对齐 CoinGlass V4）

### 改动点 #4
- **文件**：`services-preview/api-service/src/utils/symbol.py`
- **位置**：`normalize_symbol()` 函数、`to_base_symbol()` 函数
- **变更类型**：新增
- **变更摘要**：Symbol 格式转换（BTC↔BTCUSDT）

### 改动点 #5
- **文件**：`services-preview/api-service/src/routers/health.py`
- **位置**：`health_check()` 函数
- **变更类型**：修改
- **变更摘要**：响应格式改为 `{code, msg, data, success}`，时间戳改为毫秒

### 改动点 #6
- **文件**：`services-preview/api-service/src/routers/coins.py`
- **位置**：`get_supported_coins()` 函数
- **变更类型**：新增（重命名自 symbols.py）
- **变更摘要**：端点 `GET /api/futures/supported-coins`，返回 BTC 格式（非 BTCUSDT）

### 改动点 #7
- **文件**：`services-preview/api-service/src/routers/ohlc.py`
- **位置**：`get_ohlc_history()` 函数
- **变更类型**：新增（重命名自 candles.py）
- **变更摘要**：端点 `GET /api/futures/ohlc/history`，symbol 改为查询参数，新增 startTime/endTime

### 改动点 #8
- **文件**：`services-preview/api-service/src/routers/open_interest.py`
- **位置**：`get_open_interest_history()` 函数
- **变更类型**：新增
- **变更摘要**：端点 `GET /api/futures/open-interest/history`

### 改动点 #9
- **文件**：`services-preview/api-service/src/routers/funding_rate.py`
- **位置**：`get_funding_rate_history()` 函数
- **变更类型**：新增
- **变更摘要**：端点 `GET /api/futures/funding-rate/history`

### 改动点 #10
- **文件**：`services-preview/api-service/src/routers/futures_metrics.py`
- **位置**：`get_futures_metrics()` 函数
- **变更类型**：新增（重命名自 metrics.py）
- **变更摘要**：端点 `GET /api/futures/metrics`，字段改为驼峰命名

### 改动点 #11
- **文件**：`services-preview/api-service/src/routers/indicator.py`
- **位置**：`get_indicator_list()` 函数、`get_indicator_data()` 函数
- **变更类型**：新增（重命名自 indicators.py）
- **变更摘要**：端点改为 `GET /api/indicator/list` 和 `GET /api/indicator/data`，table 改为查询参数

### 改动点 #12
- **文件**：`services-preview/api-service/src/routers/signal.py`
- **位置**：`get_cooldown_status()` 函数
- **变更类型**：新增（重命名自 signals.py）
- **变更摘要**：端点改为 `GET /api/signal/cooldown`，时间戳改为毫秒

### 改动点 #13
- **文件**：`services-preview/api-service/src/routers/__init__.py`
- **位置**：模块导出
- **变更类型**：修改
- **变更摘要**：更新路由导出（新增 coins/ohlc/open_interest/funding_rate/futures_metrics/indicator/signal）

### 改动点 #14
- **文件**：`services-preview/api-service/src/app.py`
- **位置**：路由注册
- **变更类型**：修改
- **变更摘要**：路由前缀改为 `/api/futures`、`/api`（去掉 v1）

### 改动点 #15
- **文件**：`services-preview/api-service/docs/API_SPEC_COMPARISON.md`
- **位置**：新文件
- **变更类型**：新增
- **变更摘要**：CoinGlass V4 规范对比文档

### 改动点 #16
- **文件**：`services-preview/api-service/docs/API_EXAMPLES.md`
- **位置**：新文件
- **变更类型**：新增
- **变更摘要**：API 调用示例文档（cURL/Python/JavaScript）

### 改动点 #17-26（基础配置文件）
- **文件**：`services-preview/api-service/` 下的基础配置文件
- **位置**：`.python-version`、`.gitignore`、`pyproject.toml`、`requirements.txt`、`requirements-dev.txt`、`Makefile`、`scripts/start.sh`、`src/__init__.py`、`src/__main__.py`、`src/config.py`、`src/schemas/models.py`、`tests/conftest.py`
- **变更类型**：新增
- **变更摘要**：标准化服务目录结构

### 删除的文件
| 原文件 | 处理方式 |
|:---|:---|
| `src/routers/symbols.py` | 重命名为 coins.py |
| `src/routers/candles.py` | 重命名为 ohlc.py |
| `src/routers/metrics.py` | 重命名为 futures_metrics.py |
| `src/routers/indicators.py` | 重命名为 indicator.py |
| `src/routers/signals.py` | 重命名为 signal.py |

---

## 3. 改了什么（What）

### 行为变化（对外表现）
1. 新增 API 服务，端口 8089
2. 所有端点返回统一格式：`{"code": "0", "msg": "success", "data": [...], "success": true}`
3. telegram-service 后台缓存刷新不再报 psutil 错误

### 接口/配置/数据结构变化

#### 端点变化
| 旧端点 | 新端点 |
|:---|:---|
| `GET /health` | `GET /api/health` |
| `GET /api/v1/symbols` | `GET /api/futures/supported-coins` |
| `GET /api/v1/candles/{symbol}` | `GET /api/futures/ohlc/history?symbol=` |
| `GET /api/v1/metrics/{symbol}` | `GET /api/futures/metrics?symbol=` |
| `GET /api/v1/indicators/tables` | `GET /api/indicator/list` |
| `GET /api/v1/indicators/{table}` | `GET /api/indicator/data?table=` |
| `GET /api/v1/signals/cooldown` | `GET /api/signal/cooldown` |
| - | `GET /api/futures/open-interest/history` (新增) |
| - | `GET /api/futures/funding-rate/history` (新增) |

#### 参数变化
| 变化项 | 旧 | 新 |
|:---|:---|:---|
| symbol | 路径参数 | 查询参数，支持 BTC 和 BTCUSDT |
| table | 路径参数 | 查询参数 |
| exchange | 无 | 新增，默认 Binance |
| startTime | 无 | 新增，毫秒时间戳 |
| endTime | 无 | 新增，毫秒时间戳 |
| interval | 1m/5m/15m/1h/4h/1d | 新增 30m/12h |

#### 响应字段变化
| 旧字段 | 新字段 |
|:---|:---|
| timestamp (ISO) | time (毫秒) |
| open (浮点) | open (字符串) |
| open_interest | openInterest |
| long_short_ratio | longShortRatio |
| ["BTCUSDT", ...] | ["BTC", ...] |

### 关键边界条件与例外
- 无效 interval 返回错误码 `40003`
- 表不存在返回错误码 `40004`
- 数据库连接失败返回错误码 `50001`

---

## 4. 为什么要改（Why）

### 背景与问题现象
1. telegram-service 日志报错：`❌ 后台缓存刷新失败: No module named 'psutil'`
2. 业务需求：需要对外提供数据消费 API，供外部系统调用核心服务的数据
3. API 规范要求：对齐 CoinGlass API V4 标准，便于外部对接

### 根因
1. psutil 未在 requirements.txt 中声明
2. 项目缺少对外 API 服务
3. 初版 API 设计未参考行业标准

### 不改的风险/影响
1. telegram-service 后台缓存刷新持续失败
2. 无法对外提供数据接口，限制数据复用
3. 非标准 API 增加外部对接成本

---

## 5. 怎么改的（How）

### 设计选择与实现要点
1. **技术栈**：FastAPI + Uvicorn + Pydantic + psycopg + sqlite3
2. **响应格式**：统一使用 `api_response()` 和 `error_response()` 构建
3. **Symbol 处理**：`normalize_symbol()` 自动补 USDT，`to_base_symbol()` 去掉 USDT
4. **时间格式**：统一为毫秒时间戳

### 关键调用链/数据流
```
HTTP 请求 
  → FastAPI Router 
  → normalize_symbol() 转换 symbol
  → psycopg/sqlite3 查询数据库
  → api_response() 构建响应
  → JSON 返回
```

### 数据源映射
| 端点 | 数据库 | 表 |
|:---|:---|:---|
| /futures/ohlc/history | TimescaleDB | market_data.candles_1m |
| /futures/metrics | TimescaleDB | market_data.binance_futures_metrics_5m |
| /futures/open-interest/history | TimescaleDB | market_data.binance_futures_metrics_5m |
| /futures/funding-rate/history | TimescaleDB | market_data.binance_futures_metrics_5m |
| /futures/supported-coins | SQLite | 基础数据同步器.py |
| /indicator/* | SQLite | 38张指标表 |
| /signal/cooldown | SQLite | cooldown |

### 异常处理与容错策略
- 数据库连接失败：返回 `{"code": "50001", "msg": "数据库连接失败: ..."}`
- 查询失败：返回 `{"code": "50002", "msg": "查询失败: ..."}`
- 参数校验：FastAPI 自动校验 + 自定义 interval 校验

### 兼容性与迁移
- 旧端点已删除，需更新调用方
- 文档 `API_SPEC_COMPARISON.md` 记录新旧对照

---

## 6. 修改目的与验收标准（Acceptance Criteria）

### 修改目的
1. 创建符合 CoinGlass V4 规范的 API 服务
2. 修复 telegram-service psutil 缺失

### AC1：API 健康检查
- **验收方式**：命令
- **通过条件**：
```bash
curl "http://localhost:8089/api/health"
# 返回 {"code":"0","msg":"success","data":{"status":"healthy",...},"success":true}
```

### AC2：支持币种列表返回 BTC 格式
- **验收方式**：命令
- **通过条件**：
```bash
curl "http://localhost:8089/api/futures/supported-coins"
# data 数组包含 "BTC"、"ETH"（非 BTCUSDT）
```

### AC3：K线数据端点正常
- **验收方式**：命令
- **通过条件**：
```bash
curl "http://localhost:8089/api/futures/ohlc/history?symbol=BTC&limit=3"
# 返回 code:"0"，data 包含 time/open/high/low/close/volume 字段
```

### AC4：指标数据端点正常
- **验收方式**：命令
- **通过条件**：
```bash
curl "http://localhost:8089/api/indicator/list"
# 返回 38 张指标表
curl "http://localhost:8089/api/indicator/data?table=ADX.py&symbol=BTC&limit=2"
# 返回指标数据
```

### AC5：telegram-service 无 psutil 报错
- **验收方式**：重启服务后检查日志
- **通过条件**：日志中不再出现 `No module named 'psutil'`

---

## 7. 测试与验证

### 已执行测试/验证

| 端点 | 命令 | 结果 |
|:---|:---|:---|
| /api/health | `curl "http://localhost:8089/api/health"` | ✅ code:"0", status:"healthy" |
| /api/futures/supported-coins | `curl ...` | ✅ 495 币种，BTC 格式 |
| /api/futures/ohlc/history | `curl "...?symbol=BTC&limit=3"` | ✅ 返回 3 条 K线 |
| /api/futures/open-interest/history | `curl "...?symbol=BTC&limit=3"` | ✅ 返回 OI 数据 |
| /api/futures/funding-rate/history | `curl "...?symbol=BTC&limit=3"` | ✅ 返回 FR 数据 |
| /api/futures/metrics | `curl "...?symbol=ETH&limit=2"` | ✅ 返回综合指标 |
| /api/indicator/list | `curl ...` | ✅ 38 张表 |
| /api/indicator/data | `curl "...?table=K线形态扫描器.py&limit=5"` | ✅ 返回形态数据 |
| /api/signal/cooldown | `curl ...` | ✅ 返回冷却状态 |

### 未覆盖项与原因
- 单元测试：仅创建 conftest.py 框架，未编写具体测试用例
- startTime/endTime 参数：未在测试中验证时间范围筛选
- 错误码场景：未完整测试所有错误码返回

---

## 8. 风险与回滚

### 风险点
1. 端口 8088 被占用，实际使用 8089，需配置 `API_SERVICE_PORT` 环境变量
2. 旧端点路径已删除，调用方需同步更新
3. 数据库 schema 依赖 TimescaleDB 5433 端口的 `market_data.candles_1m` 表

### 回滚策略/路径
```bash
# 停止服务
cd services-preview/api-service && ./scripts/start.sh stop

# 回滚到上一个提交
git revert d4d6d1fd  # docs
git revert bdc8c88c  # refactor
git revert e591f3df  # feat

# 或删除整个服务目录
rm -rf services-preview/api-service

# 回滚 telegram-service 依赖
# 编辑 services/telegram-service/requirements.txt 删除 psutil 行
```

---

## 9. 文件清单

### 新增文件
```
services-preview/api-service/
├── .gitignore
├── .python-version
├── Makefile
├── pyproject.toml
├── requirements.txt
├── requirements-dev.txt
├── requirements.lock.txt
├── docs/
│   ├── API_SPEC_COMPARISON.md
│   ├── API_EXAMPLES.md
│   └── 改动1.md
├── scripts/
│   └── start.sh
├── src/
│   ├── __init__.py
│   ├── __main__.py
│   ├── app.py
│   ├── config.py
│   ├── routers/
│   │   ├── __init__.py
│   │   ├── health.py
│   │   ├── coins.py
│   │   ├── ohlc.py
│   │   ├── open_interest.py
│   │   ├── funding_rate.py
│   │   ├── futures_metrics.py
│   │   ├── indicator.py
│   │   └── signal.py
│   ├── schemas/
│   │   ├── __init__.py
│   │   └── models.py
│   └── utils/
│       ├── __init__.py
│       ├── errors.py
│       └── symbol.py
├── tests/
│   ├── __init__.py
│   └── conftest.py
├── logs/
└── pids/
```

### 修改文件
```
services/telegram-service/requirements.txt  # 添加 psutil>=5.9.0
services/telegram-service/requirements.lock.txt  # 更新锁定依赖
```

---

## 10. Git 提交记录

| 提交 | 说明 |
|:---|:---|
| `e591f3df` | feat(api): add api-service and fix telegram-service psutil dependency |
| `bdc8c88c` | refactor(api): align with CoinGlass API V4 specification |
| `d4d6d1fd` | docs(api): add API call examples documentation |

---

*文档版本: 1.0*
*创建时间: 2026-01-16*
